<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cozinha - Mava Baristro</title>

<link rel="stylesheet" href="admin.css">
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* BADGES */
.status-badge{
    display:inline-block;
    padding:6px 12px;
    border-radius:8px;
    font-weight:bold;
    margin-top:10px;
    font-size:13px;
}
.status-novo{ background:#d9534f; color:white; }
.status-prep{ background:#f0ad4e; color:white; }
.status-pronto{ background:#5cb85c; color:white; }

/* CARTÃO DO PEDIDO */
.pedido-card{
    background:white;
    border-radius:14px;
    padding:16px 18px;
    margin-bottom:15px;
    box-shadow:0 3px 12px rgba(0,0,0,0.12);
    transition:.25s;
    border-left:4px solid var(--dourado);
}
.pedido-card:hover{
    transform:translateY(-3px);
    box-shadow:0 5px 16px rgba(0,0,0,0.18);
}
.pedido-card h3{
    color:var(--azul);
    margin-bottom:4px;
    font-size:18px;
}
.pedido-card .sub{
    font-size:13px;
    color:#555;
    margin-bottom:6px;
}
.pedido-card ul{
    padding-left:20px;
    margin-top:5px;
    font-size:14px;
}

/* PISCAR NOVO PEDIDO */
@keyframes piscar {
    0%{background-color:#fff6c7;}
    50%{background-color:#ffeaa7;}
    100%{background-color:#fff6c7;}
}
.pedido-novo-flash{
    animation: piscar 1s ease-in-out 4;
}

/* POPUP */
.popup-alert {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: var(--azul);
    color: var(--dourado);
    padding: 15px 20px;
    border-radius: 10px;
    font-weight: bold;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    animation: aparecer .4s ease;
    z-index: 9999;
    font-size:14px;
}

@keyframes aparecer {
    from {opacity: 0; transform: translateY(20px);}
    to {opacity: 1; transform: translateY(0);}
}

.btn-row{
    margin-top:14px;
    display:flex;
    gap:8px;
}

.btn{
    padding:10px 14px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
}
.btn-warning{ background:#f0ad4e;color:white; }
.btn-primary{ background:#0275d8;color:white; }
</style>
</head>

<body>

<!-- MENU -->
<div class="menu-toggle" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
</div>

<div class="sidebar" id="sidebar">
    <h2>Mava Baristro</h2>

    <div class="menu-item" onclick="go('dashboard.html')">
        <i class="fas fa-chart-line"></i> Dashboard
    </div>

    <div class="menu-item" onclick="go('produtos.html')">
        <i class="fas fa-mug-hot"></i> Produtos
    </div>

    <div class="menu-item active" onclick="go('cozinha.html')">
        <i class="fas fa-kitchen-set"></i> Cozinha 
        <span id="badgeCozinha"
              style="display:none;background:#d9534f;color:white;
              padding:2px 8px;border-radius:10px;font-size:12px;margin-left:6px;">!</span>
    </div>

    <div class="menu-item" onclick="go('caixa.html')">
        <i class="fas fa-cash-register"></i> Caixa
    </div>

    <div class="menu-item" onclick="go('mesas.html')">
        <i class="fas fa-chair"></i> Mesas
    </div>

    <div class="menu-item" onclick="go('colaboradores.html')">
        <i class="fas fa-users"></i> Colaboradores
    </div>

    <div class="menu-item" onclick="logout()">
        <i class="fas fa-door-open"></i> Sair
    </div>
</div>

<div class="content">
    <h1 class="title">
        <i class="fas fa-kitchen-set"></i> Pedidos da Cozinha
    </h1>

    <p style="margin-bottom:10px;font-size:14px;color:#555;">
        Os pedidos aparecem em: <b>NOVO → PREPARANDO → PRONTO</b>.
    </p>

    <div id="lista"></div>
</div>

<!-- ÁUDIO NOVO — SEGURO E COMPATÍVEL -->
<audio id="alertSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-censor-beep-1082.mp3" type="audio/mpeg">
</audio>

<!-- POPUP -->
<div id="popup" class="popup-alert"></div>

<!-- DESBLOQUEIO DE ÁUDIO (OBRIGATÓRIO PARA CHROME/IOS) -->
<script>
document.addEventListener("click", function startAudio() {
    const audio = document.getElementById("alertSound");
    audio.volume = 1;
    audio.play().catch(()=>{});
    document.removeEventListener("click", startAudio);
});
</script>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut }
 from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { ref, onValue, update }
 from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

onAuthStateChanged(auth, user => {
    if (!user) window.location.href = "../login.html";
});
window.logout = () => signOut(auth);

const lista = document.getElementById("lista");
const popup = document.getElementById("popup");
const badge = document.getElementById("badgeCozinha");
const alertSound = document.getElementById("alertSound");

let primeiraLeitura = true;
let ultimoAnunciado = null;

onValue(ref(db, "pedidos"), snap => {

    const pedidos = [];
    snap.forEach(item => {
        const p = item.val();
        const id = item.key;

        if (!p || p.status === "finalizado") return;

        pedidos.push({ id, ...p });
    });

    pedidos.sort((a,b)=>{
        const ordem = { novo:1, preparando:2, pronto:3 };
        if (ordem[a.status] !== ordem[b.status])
            return ordem[a.status] - ordem[b.status];
        return (a.hora||0) - (b.hora||0);
    });

    /* ALERTA DE NOVO PEDIDO */
    if (!primeiraLeitura) {
        const novo = pedidos.find(x => x.status === "novo");

        if (novo && novo.id !== ultimoAnunciado) {
            ultimoAnunciado = novo.id;

            alertSound.currentTime = 0;
            alertSound.play().catch(()=>{});

            popup.innerText = `Novo pedido — Mesa ${novo.mesa} (${novo.nomeCliente || "Cliente"})`;
            popup.style.display = "block";
            setTimeout(()=> popup.style.display="none", 4000);

            badge.style.display = "inline-block";

            setTimeout(()=>{
                const c = document.getElementById("pedido-"+novo.id);
                if (c) c.classList.add("pedido-novo-flash");
            },300);
        }
    }
    primeiraLeitura = false;

    /* RENDERIZAR */
    lista.innerHTML = "";

    pedidos.forEach(p=>{
        lista.innerHTML += `
            <div class="pedido-card" id="pedido-${p.id}">
                <h3>Mesa ${p.mesa} — ${p.nomeCliente || "Cliente"}</h3>
                <p class="sub"><b>Horário:</b> ${new Date(p.hora).toLocaleTimeString("pt-BR")}</p>

                <p><b>Itens:</b></p>
                <ul>${(p.itens||[]).map(i=>`<li>${i}</li>`).join("")}</ul>

                <p style="margin-top:6px;font-size:14px;">
                    <b>Total estimado:</b> R$ ${Number(p.total).toFixed(2)}
                </p>

                <span class="status-badge ${
                    p.status==="novo" ? "status-novo" :
                    p.status==="preparando" ? "status-prep" : "status-pronto"
                }">
                    ${p.status.toUpperCase()}
                </span>

                <div class="btn-row">
                    ${p.status==="novo" ? `
                        <button class="btn btn-warning" onclick="preparar('${p.id}')">
                            <i class="fas fa-fire"></i> Preparar
                        </button>` : ""}

                    ${p.status==="preparando" ? `
                        <button class="btn btn-primary" onclick="pronto('${p.id}')">
                            <i class="fas fa-check"></i> Pronto
                        </button>` : ""}
                </div>
            </div>
        `;
    });

});

window.preparar = id =>
    update(ref(db,"pedidos/"+id),{status:"preparando"});

window.pronto = id =>
    update(ref(db,"pedidos/"+id),{status:"pronto"});
</script>

<script>
function go(p){ window.location.href = p; }
function toggleMenu(){
    document.getElementById("sidebar").classList.toggle("active");
}
</script>

</body>
</html>
