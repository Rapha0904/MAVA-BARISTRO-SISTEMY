<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Produtos - Mava Baristro</title>

<link rel="stylesheet" href="admin.css">
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>

/* -------- ESTILO ESPECIAL DA PÁGINA -------- */

.card{
    padding:22px;
    border-radius:16px;
    background:white;
    box-shadow:0 4px 18px rgba(0,0,0,0.10);
    border-left:6px solid var(--dourado);
    margin-bottom:25px;
}

#titulo-form{
    font-size:22px;
    font-weight:bold;
}

input, textarea, select{
    width:100%;
    padding:12px;
    font-size:15px;
    border:1px solid #bbb;
    border-radius:10px;
    margin-bottom:12px;
}

textarea{
    min-height:70px;
    resize:none;
}

.btn-primary{
    background:var(--azul);
    color:white;
    padding:12px 18px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-weight:bold;
    transition:.2s;
}

.btn-primary:hover{
    background:#0d153b;
}

.btn-edit{
    background:var(--dourado);
    color:white;
}

.prod-card{
    background:white;
    border-radius:14px;
    padding:16px;
    box-shadow:0 3px 12px rgba(0,0,0,0.10);
    display:flex;
    gap:16px;
    align-items:flex-start;
    margin-bottom:16px;
    transition:.25s;
}

.prod-card:hover{
    transform:translateY(-4px);
}

.prod-img{
    width:120px;
    height:120px;
    object-fit:cover;
    border-radius:12px;
    border:2px solid var(--dourado);
}

.prod-info h3{
    margin-bottom:6px;
    color:var(--azul);
    font-size:20px;
}

.prod-info p{ margin:2px 0; }

.prod-actions button{
    margin-right:10px;
}

</style>
</head>

<body>

<!-- BOTÃO MENU MOBILE -->
<div class="menu-toggle" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">

    <h2>Mava Baristro</h2>

    <div class="menu-item" onclick="go('dashboard.html')">
        <i class="fas fa-chart-line"></i> Dashboard
    </div>

    <div class="menu-item active" onclick="go('produtos.html')">
        <i class="fas fa-mug-hot"></i> Produtos
    </div>

    <div class="menu-item" onclick="go('cozinha.html')">
        <i class="fas fa-kitchen-set"></i> Cozinha
    </div>

    <div class="menu-item" onclick="go('caixa.html')">
        <i class="fas fa-cash-register"></i> Caixa
    </div>

    <div class="menu-item" onclick="go('mesas.html')">
        <i class="fas fa-chair"></i> Mesas
    </div>

    <div class="menu-item" onclick="go('colaboradores.html')">
        <i class="fas fa-users"></i> Colaboradores
    </div>

    <div class="menu-item" onclick="logout()">
        <i class="fas fa-door-open"></i> Sair
    </div>

</div>

<!-- CONTEÚDO -->
<div class="content">

    <h1 class="title">Gerenciar Produtos</h1>

    <!-- FORMULÁRIO -->
    <div class="card">
        <h2 id="titulo-form">Cadastrar Produto</h2>

        <input id="nome" placeholder="Nome do produto">
        <input id="preco" placeholder="Preço (ex: 12.50)">
        <textarea id="descricao" placeholder="Descrição do produto"></textarea>

        <select id="categoria">
            <option value="">Selecione a categoria</option>
            <option value="cafes">Cafés</option>
            <option value="bebidas">Bebidas</option>
            <option value="doces">Doces</option>
            <option value="salgados">Salgados</option>
        </select>

        <select id="quantidade">
            <option value="">Unidade / Quantidade</option>
            <option value="200g">200g</option>
            <option value="500g">500g</option>
            <option value="1kg">1kg</option>
            <option value="200ml">200ml</option>
            <option value="500ml">500ml</option>
            <option value="600ml">600ml</option>
            <option value="700ml">700ml</option>
            <option value="1L">1L</option>
            <option value="2L">2L</option>
        </select>

        <label><b>Foto do produto:</b></label>
        <input type="file" id="foto" accept="image/*">

        <button class="btn-primary" id="btn-salvar">
            <i class="fas fa-save"></i> <span id="texto-botao">Cadastrar Produto</span>
        </button>
    </div>

    <!-- LISTA DE PRODUTOS -->
    <div class="card">
        <h2 style="margin-bottom:12px;">Produtos cadastrados</h2>
        <div id="listaProdutos"></div>
    </div>

</div>

<script type="module">
/* ========= IMPORTS FIREBASE ========= */
import { auth, db } from "./firebase.js";
import {
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import {
    ref,
    onValue,
    push,
    set,
    remove
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ========= PROTEÇÃO ========= */
onAuthStateChanged(auth, user => {
    if (!user) window.location.href = "../login.html";
});
window.logout = () => signOut(auth);

/* ========= VARIÁVEIS ========= */
let editId = null;
let fotoAtual = null;
const produtosCache = {};

const btnSalvar = document.getElementById("btn-salvar");
const textoBotao = document.getElementById("texto-botao");
const tituloForm = document.getElementById("titulo-form");

/* ========= BASE64 ========= */
function converterBase64(file){
    return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload  = ()=> resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
    });
}

/* ========= SALVAR / ATUALIZAR ========= */
btnSalvar.onclick = async () => {

    const nome = document.getElementById("nome").value.trim();
    const preco = document.getElementById("preco").value.trim();
    const descricao = document.getElementById("descricao").value.trim();
    const categoria = document.getElementById("categoria").value;
    const quantidade = document.getElementById("quantidade").value;
    const fotoFile = document.getElementById("foto").files[0];

    if (!nome || !preco || !categoria){
        alert("Preencha ao menos Nome, Preço e Categoria.");
        return;
    }

    try{
        let base64;

        if(editId){
            base64 = fotoFile ? await converterBase64(fotoFile) : fotoAtual;

            await set(ref(db, "produtos/" + editId), {
                nome, preco, descricao, categoria, quantidade, foto:base64
            });

            alert("Produto atualizado!");
        }else{
            if(!fotoFile){
                alert("Selecione a foto do produto!");
                return;
            }

            base64 = await converterBase64(fotoFile);

            await push(ref(db, "produtos"), {
                nome, preco, descricao, categoria, quantidade, foto:base64
            });

            alert("Produto cadastrado!");
        }

        limparFormulario();

    }catch(e){
        console.error(e);
        alert("Erro ao salvar.");
    }
};

/* ========= LIMPAR FORM ========= */
function limparFormulario(){
    document.getElementById("nome").value = "";
    document.getElementById("preco").value = "";
    document.getElementById("descricao").value = "";
    document.getElementById("categoria").value = "";
    document.getElementById("quantidade").value = "";
    document.getElementById("foto").value = "";

    editId = null;
    fotoAtual = null;
    textoBotao.textContent = "Cadastrar Produto";
    tituloForm.textContent = "Cadastrar Produto";
}

/* ========= LISTA ========= */
const lista = document.getElementById("listaProdutos");

onValue(ref(db, "produtos"), snap => {
    lista.innerHTML = "";
    Object.keys(produtosCache).forEach(k => delete produtosCache[k]);

    snap.forEach(item => {
        const p = item.val();
        const id = item.key;

        produtosCache[id] = p;

        lista.innerHTML += `
            <div class="prod-card">
                <img class="prod-img" src="${p.foto}">
                
                <div class="prod-info" style="flex:1;">
                    <h3>${p.nome}</h3>
                    <p><b>Preço:</b> R$ ${p.preco}</p>
                    <p><b>Categoria:</b> ${p.categoria}</p>
                    <p><b>Quantidade:</b> ${p.quantidade || "-"}</p>
                    <p><b>Descrição:</b> ${p.descricao || "-"}</p>

                    <div class="prod-actions" style="margin-top:10px;">
                        <button class="btn-edit" onclick="editarProduto('${id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>

                        <button class="btn-danger btn" onclick="excluirProduto('${id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
});

/* ========= EDITAR ========= */
window.editarProduto = (id)=>{
    const p = produtosCache[id];
    if(!p) return;

    editId = id;
    fotoAtual = p.foto;

    document.getElementById("nome").value = p.nome;
    document.getElementById("preco").value = p.preco;
    document.getElementById("descricao").value = p.descricao || "";
    document.getElementById("categoria").value = p.categoria;
    document.getElementById("quantidade").value = p.quantidade || "";
    document.getElementById("foto").value = "";

    textoBotao.textContent = "Atualizar Produto";
    tituloForm.textContent = "Editar Produto";

    window.scrollTo({ top:0, behavior:"smooth" });
};

/* ========= EXCLUIR ========= */
window.excluirProduto = (id)=>{
    if(confirm("Excluir produto?")){
        remove(ref(db, "produtos/" + id));
    }
};
</script>

<script>
function go(p){ window.location.href = p; }
function toggleMenu(){ document.getElementById("sidebar").classList.toggle("active"); }
</script>

</body>
</html>
